<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>è‹±æ¤œï¼“ç´š Present Perfect Picture Grammar</title>

<!-- jsPDF -->



<style>
body{
  font-family:"Hiragino Maru Gothic ProN",sans-serif;
  background:#fff9e6;
  text-align:center;
  padding:20px;
}
.frame{
  border:3px solid #b6d957;
  background:#fff;
  padding:20px;
  max-width:980px;
  margin:auto;
  border-radius:12px;
}
.qnum{font-size:24px;font-weight:bold;}
.grammar{
  font-size:18px;
  color:#2b6cb0;
  margin:6px 0;
  font-weight:bold;
}
.row{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(90px,1fr));
  gap:10px;
  margin:14px 0;
}
.slot{
  height:60px;
  border:2px dashed #bbb;
  border-radius:8px;
  display:flex;
  align-items:center;
  justify-content:center;
}
.card{
  background:#e6f5e6;
  padding:8px 12px;
  border-radius:8px;
  box-shadow:2px 2px 6px rgba(0,0,0,.25);
  cursor:pointer;
  user-select:none;
  font-size:16px;
  font-weight:bold;
}
button{
  padding:8px 18px;
  font-size:16px;
  margin:6px;
}
#message{
  font-size:20px;
  height:28px;
  font-weight:bold;
}
#progress{
  margin-bottom:10px;
  font-size:16px;
  color:#444;
}
#hintBox{
  margin-top:12px;
}
@media print{

  body{
    background:white;
  }

  .frame{
    display:none;
  }

  #printArea,
  #answerPage{
    display:block !important;
    padding:20px;
  }

  .print-row{
  display:flex;
  align-items:flex-start;
  margin-bottom:30px;

  page-break-inside: avoid;
  break-inside: avoid;
  }


  .print-row img{
    width:40%;
    margin-right:20px;
  }

  .print-text{
    width:60%;
    font-size:18px;
    text-align:left;
  }

  #answerPage{
    page-break-before:always;
  }
}

</style>
</head>

<body>

<h2>è‹±æ¤œï¼“ç´š Present Perfect Picture Grammar</h2>

<div class="frame">

  <div id="progress">
    å…¨ <b id="totalQ"></b> å•ã‚ã‚Šã¾ã™
  </div>

  <div class="qnum" id="qnum"></div>
  <div class="grammar" id="grammar"></div>

  <div class="row" id="answerRow"></div>
  <div class="row" id="cardRow"></div>

  <button onclick="checkAnswer()">Check</button>
  <button onclick="shuffle()">Shuffle</button>
  <button id="nextBtn" onclick="nextQ()" style="display:none">NEXT â–¶</button>
  <button onclick="toggleHint()">ãƒ’ãƒ³ãƒˆ</button>
  <button onclick="exportPDF()">ğŸ“„ PDFã§å•é¡Œã‚’å‡ºã™</button>
  <button onclick="startReview()">ğŸ” é–“é•ãˆãŸå•é¡Œã‚’å¾©ç¿’</button>


  <div id="hintBox" style="display:none;">
    <img id="hintImg" style="max-width:220px;"><br>
    <div id="hintJP" style="margin-top:6px;font-size:15px;color:#555;"></div>
  </div>

  <div id="message"></div>
</div>

<canvas id="confetti" style="position:fixed;top:0;left:0;pointer-events:none;"></canvas>

<script>
const data=[
{
  grammar:"ç¾åœ¨å®Œäº†ï¼ˆç¶™ç¶šï¼‰",
  en:["James","has","lived","in","Japan","for","twelve","years","."],
  jp:"ã‚¸ã‚§ãƒ¼ãƒ ã‚ºã¯12å¹´é–“ãšã£ã¨æ—¥æœ¬ã«ä½ã‚“ã§ã„ã¾ã™ã€‚",
  img:"images/1.png"
},
{
  grammar:"ç¾åœ¨å®Œäº†ï¼ˆçµŒé¨“ï¼‰",
  en:["Julie","has","been","to","Kyoto","twice","."],
  jp:"ã‚¸ãƒ¥ãƒªãƒ¼ã¯äº¬éƒ½ã«2å›è¡Œã£ãŸã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚",
  img:"images/2.png"
},
{
  grammar:"ç¾åœ¨å®Œäº†ï¼ˆçµŒé¨“ãƒ»å¦å®šï¼‰",
  en:["Greg","has","never","eaten","natto","."],
  jp:"ã‚°ãƒ¬ãƒƒã‚°ã¯ç´è±†ã‚’ä¸€åº¦ã‚‚é£Ÿã¹ãŸã“ã¨ãŒã‚ã‚Šã¾ã›ã‚“ã€‚",
  img:"images/3.png"
},
{
  grammar:"ç¾åœ¨å®Œäº†ï¼ˆå®Œäº†ï¼‰",
  en:["I","have","just","finished","my","homework","."],
  jp:"ãŸã£ãŸä»Šã€å®¿é¡Œã‚’çµ‚ãˆãŸã¨ã“ã‚ã§ã™ã€‚",
  img:"images/4.png"
},
{
  grammar:"ç¾åœ¨å®Œäº†ï¼ˆå®Œäº†ï¼‰",
  en:["I","have","already","done","my","homework","."],
  jp:"ã‚‚ã†å®¿é¡Œã¯ã‚„ã‚Šã¾ã—ãŸã€‚",
  img:"images/5.png"
},
{
  grammar:"ç¾åœ¨å®Œäº†ï¼ˆç–‘å•ãƒ»yetï¼‰",
  en:["Have","you","done","your","homework","yet","?"],
  jp:"ã‚‚ã†å®¿é¡Œã¯ã‚„ã‚Šã¾ã—ãŸã‹ã€‚",
  img:"images/6.png"
},
{
  grammar:"ç¾åœ¨å®Œäº†ï¼ˆæœªå®Œäº†ãƒ»yetï¼‰",
  en:["I","have","not","done","my","homework","yet","."],
  jp:"ã¾ã å®¿é¡Œã‚’ã‚„ã£ã¦ã„ã¾ã›ã‚“ã€‚",
  img:"images/7.png"
},
{
  grammar:"ç¾åœ¨å®Œäº†ï¼ˆçµæœï¼‰",
  en:["Kelly","has","gone","to","India","."],
  jp:"ã‚±ãƒªãƒ¼ã¯ã‚¤ãƒ³ãƒ‰ã«è¡Œã£ã¦ã—ã¾ã„ã¾ã—ãŸã€‚",
  img:"images/8.png"
}
];

let cur=0;
let dragged=null;
let wrongList=[];
let reviewMode=false;
let reviewIndex=0;

function hideHint(){
  document.getElementById("hintBox").style.display="none";
}

function loadQ(){
  hideHint();
  message.textContent="";
  nextBtn.style.display="none";

  const q=data[cur];
  qnum.textContent="Q"+(cur+1);
  grammar.textContent=q.grammar;

  answerRow.innerHTML="";
  cardRow.innerHTML="";
  q.en.forEach((w,i)=>{
    answerRow.appendChild(makeSlot());
    cardRow.appendChild(makeSlot(w,i));
  });
  shuffle();
}

function makeSlot(word="",home=null){
  const s=document.createElement("div");
  s.className="slot";
  s.ondragover=e=>e.preventDefault();
  s.ondrop=()=>{ if(dragged && !s.firstChild) s.appendChild(dragged); };

  if(word){
    const c=document.createElement("div");
    c.className="card";
    c.textContent=word;
    c.dataset.home=home;
    c.draggable=true;
    c.onclick=()=>tapMove(c);
    c.ondragstart=()=>dragged=c;
    s.appendChild(c);
  }
  s.onclick=()=>{
    if(s.parentElement.id==="answerRow" && s.firstChild){
      cardRow.children[s.firstChild.dataset.home].appendChild(s.firstChild);
    }
  };
  return s;
}

function tapMove(card){
  const empty=[...answerRow.children].find(s=>!s.firstChild);
  if(empty) empty.appendChild(card);
}

function shuffle(){
  const cards=[...document.querySelectorAll(".card")];
  cardRow.querySelectorAll(".slot").forEach(s=>s.innerHTML="");
  cards.sort(()=>Math.random()-.5)
       .forEach((c,i)=>cardRow.children[i].appendChild(c));
}

function checkAnswer(){
  const ans=[...answerRow.children].map(s=>s.firstChild?.textContent||"");
  if(JSON.stringify(ans)===JSON.stringify(data[cur].en)){
    message.textContent="Correct! âœ…";
    speak();
    nextBtn.style.display="inline-block";
  }else{
    message.textContent="Try again âŒ";
    if(!wrongList.includes(cur)){
      wrongList.push(cur);
    }
  }
}

function speak(){
  const u=new SpeechSynthesisUtterance(data[cur].en.join(" "));
  u.lang="en-US";
  u.rate=0.75;
  speechSynthesis.speak(u);
}

function nextQ(){

  if(reviewMode){
    reviewIndex++;
    if(reviewIndex < wrongList.length){
      cur=wrongList[reviewIndex];
      loadQ();
    }else{
      finishGame();
    }
  }else{
    cur++;
    if(cur < data.length){
      loadQ();
    }else{
      finishGame();
    }
  }
}

function loadReview(){
  cur = wrongList[reviewIndex];
  loadQ();
}

function finish(){
  if(wrongList.length>0 && !reviewMode){
    reviewMode=true;
    reviewIndex=0;
    message.textContent="å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰ï¼ã¾ã¡ãŒãˆãŸå•é¡Œã‚’ã‚‚ã†ä¸€åº¦âœ¨";
    loadReview();
  }else{
    message.textContent="å…¨éƒ¨å®Œæˆï¼Perfect!! ğŸ‰";
    launchConfetti();
  }
}

function toggleHint(){
  const box=document.getElementById("hintBox");
  const q=data[cur];
  if(box.style.display==="none"){
    hintImg.src=q.img;
    hintJP.textContent=q.jp;
    box.style.display="block";
  }else{
    box.style.display="none";
  }
}

function startReview(){

  if(wrongList.length===0){
    alert("é–“é•ãˆãŸå•é¡Œã¯ã‚ã‚Šã¾ã›ã‚“ ğŸ˜Š");
    return;
  }

  reviewMode=true;
  reviewIndex=0;
  cur=wrongList[reviewIndex];
  loadQ();
}

function finishGame(){

  message.innerHTML = `
    <div style="font-size:28px; margin-top:20px;">
      ğŸŒ¸ ãŠã¤ã‹ã‚Œã•ã¾ã§ã—ãŸï¼ ğŸŒ¸<br>
      Way to go! ğŸ‰
    </div>
  `;

  launchConfetti();
}


/* ========= PDF ========= */
function exportPDF(){

  const area=document.getElementById("printArea");
  const answers=document.getElementById("answerList");

  area.innerHTML="";
  answers.innerHTML="";

  data.forEach((q,i)=>{

    const row=document.createElement("div");
    row.className="print-row";

    const img=document.createElement("img");
    img.src=q.img;
    img.style.width="30%";
    row.appendChild(img);

    const shuffled=[...q.en].sort(()=>Math.random()-.5);

    const text=document.createElement("div");
    text.className="print-text";
    text.style.fontSize="16px";

    text.innerHTML=`
  <div style="font-size:18px; font-weight:bold;">
    Q${i+1}. ${q.grammar}
  </div>

  <div style="font-size:14px; color:#555; margin-top:4px;">
    ï¼ˆ${q.jp}ï¼‰
  </div>

  <div style="margin-top:8px;">
    ${shuffled.join(" / ")}
  </div>

  <div style="margin-top:14px;">
    <div style="border-bottom:2px solid #000; height:28px; width:100%; margin-bottom:12px;"></div>
    <div style="border-bottom:2px solid #000; height:28px; width:100%;"></div>
  </div>
`;


    row.appendChild(text);
    area.appendChild(row);

    // â–¼ ç­”ãˆãƒšãƒ¼ã‚¸
    const li=document.createElement("li");
    li.style.textAlign="left";
    li.style.marginBottom="14px";
    li.innerHTML = `
      <div><b>${q.en.join(" ")}</b></div>
      <div style="font-size:14px; color:#444; margin-left:10px;">
        ${q.jp}
      </div>
    `;
    answers.appendChild(li);

  });

  area.style.display="block";
  document.getElementById("answerPage").style.display="block";

  setTimeout(()=>window.print(),200);
}

/* ========= ç´™å¹é›ª ========= */
function launchConfetti(){
  const canvas=document.getElementById("confetti");
  const ctx=canvas.getContext("2d");
  canvas.width=window.innerWidth;
  canvas.height=window.innerHeight;

  const pieces=[...Array(120)].map(()=>({
    x:Math.random()*canvas.width,
    y:Math.random()*canvas.height-canvas.height,
    r:Math.random()*6+4,
    c:`hsl(${Math.random()*360},80%,60%)`,
    s:Math.random()*3+2
  }));

  let t=0;
  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    pieces.forEach(p=>{
      ctx.fillStyle=p.c;
      ctx.beginPath();
      ctx.arc(p.x,p.y+=p.s,p.r,0,Math.PI*2);
      ctx.fill();
    });
    if(t++<180) requestAnimationFrame(draw);
    else ctx.clearRect(0,0,canvas.width,canvas.height);
  }
  draw();
}

loadQ();
totalQ.textContent=data.length;
</script>

<!-- ===== PDFã‚¨ãƒªã‚¢ ===== -->
<div id="printArea" style="display:none;"></div>

<div id="answerPage" style="display:none;">
  <h2>Answer</h2>
  <ol id="answerList"></ol>
</div>

</body>
</html>

